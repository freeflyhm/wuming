var multiparty = require('multiparty'),
    fs         = require('fs'),
    path       = require('path'),
    ueditor, respond;

ueditor = function(static_url, handel) {
  return function(req, res, next) {
    var _respond = respond(static_url, handel);
    _respond(req, res, next);
  };
};

respond = function(static_url, callback) {

  return function(req, res, next) {

    if (req.query.action === 'listimage' || req.query.action === 'listfile') {

      res.ue_list = function(dir_url, filetype) {
        var str  = '',
            i    = 0,
            list = [];

        fs.readdir(static_url + dir_url, function(err, files) {
          if (err) throw err;

          var total = files.length;

          files.forEach(function(file) {
            var
                tmplist   = file.split('.'),
                _filetype = tmplist[tmplist.length - 1],
                temp;

            if (filetype.indexOf(_filetype.toLowerCase()) >= 0) {
              temp = {};
              if (dir_url === '/') {
                temp.url = dir_url + file;
              } else {
                temp.url = dir_url + "/" + file;
              }
              list[i] = (temp);
            }

            i++;
            // send file name string when all files was processed
            if (i === total) {
              res.json({
                "state": "SUCCESS",
                "list": list,
                "start": 1,
                "total": total
              });
            }
          });
        });
      };
      callback(req, res, next);

    } else if (req.query.action === 'uploadimage' || req.query.action === 'uploadfile') {

      res.ue_up = function(dir_url) {
        var 
            UPLOAD_FILE = './public' + dir_url,
            // 生成 multiparty对象, 并配置下载目标路径
            form        = new multiparty.Form({uploadDir: UPLOAD_FILE});

        // 下载后处理
        form.parse(req, function(err, fields, files) {
          var inputFile, uploadedPath, dstPath;

          if (err) {
            console.log('parse files: ' + err);
          } else {

            inputFile = files.upfile[0];
            uploadedPath = inputFile.path;
            dstPath = UPLOAD_FILE + inputFile.originalFilename;

            // 重命名为真实文件名
            fs.rename(uploadedPath, dstPath, function(err) {
              var _obj;
              if (err) {
                console.log('rename error: ' + err);
              } else {
                _obj = {
                  'url': path.join(dir_url, inputFile.originalFilename),
                  'original': inputFile.originalFilename,
                  'state': 'SUCCESS'
                };

                /*console.log(_obj);
                { 
                  url: '\\images\\ueditor\\er.jpg',
                  original: 'er.jpg',
                  state: 'SUCCESS' 
                }
                */

                res.json(_obj);
              }
            });
          }
        });
      }

      callback(req, res, next);
    } else {
      callback(req, res, next);
    }
    return;
  };
};

module.exports = ueditor;